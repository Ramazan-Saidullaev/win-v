# Clipboard History Manager (Win+V для Ubuntu)

Приложение для Linux, повторяющее поведение сочетания Win+V из Windows 11: собирает историю буфера обмена (текст и изображения), показывает удобное окно поиска по истории и мгновенно вставляет выбранный элемент в активное окно.

## Оглавление
- [Основные возможности](#основные-возможности)
- [Как устроено](#как-устроено)
- [Требования](#требования)
- [Установка](#установка)
  - [Быстрый старт](#быстрый-старт)
  - [Ручная установка](#ручная-установка)
- [Запуск и управление](#запуск-и-управление)
- [Горячие клавиши](#горячие-клавиши)
- [Автозапуск](#автозапуск)
- [Хранение данных](#хранение-данных)
- [Структура репозитория](#структура-репозитория)
- [FAQ и устранение проблем](#faq-и-устранение-проблем)
- [Лицензия и автор](#лицензия-и-автор)

## Основные возможности
- Мониторинг буфера обмена в фоне с шагом ~300 мс.
- Хранение до 100 элементов (значение можно изменить в `ClipboardHistory(max_history=...)`).
- Поддержка текста и изображений (создаются превью, оригиналы сохраняются в `~/.clipboard_history_images`).
- Окно истории на Tkinter с быстрым поиском, предпросмотром изображений, навигацией клавишами и действиями «Вставить», «Удалить», «Очистить», «Перезапустить».
- Автоматическое копирование и (при наличии `pynput`) вставка выбранного элемента с имитацией `Ctrl+V`.
- Горячая клавиша по умолчанию `Ctrl+Alt+Z`. Регистрируется через `keyboard` (если есть права) или `pynput`.
- Сохранение истории между сессиями в `~/.clipboard_history.json`.
- Скрипты для установки зависимостей, автозапуска и остановки фонового процесса.

## Как устроено
- `clipboard_history.py` содержит класс `ClipboardHistory`, который:
  - следит за буфером через `pyperclip` и `xclip`,
  - сериализует историю в JSON и управляет хранилищем изображений,
  - поднимает GUI (Tkinter + ttk + Canvas) и реактивно обновляет список,
  - регистрирует глобальный хоткей (`keyboard` → `pynput` → предупреждение),
  - обеспечивает вставку выбранных элементов и управление историей.
- Скрипты:
  - `install.sh` — ставит системные пакеты (`xclip`, `xsel`, `python3-tk`), создает venv, устанавливает Python-зависимости и добавляет пользователя в группу `input`.
  - `setup_autostart.sh` — создает desktop-файл в `~/.config/autostart/` с запуском через виртуальное окружение.
  - `stop_app.sh` — завершает все процессы `clipboard_history.py`.
- Конфигурация по умолчанию (`main()` внизу файла) очищает историю при старте (`clear_on_startup=True`). Измените параметры конструктора по своим нуждам.

## Требования
- ОС: Ubuntu / Linux с X11 (под Wayland могут потребоваться дополнительные настройки).
- Python 3.8+ (проект использует venv с Python 3.12).
- Системные пакеты: `xclip`, `xsel`, `python3-tk`.
- Права: для библиотеки `keyboard` нужен доступ к `/dev/input` (обычно через группу `input` или запуск от root). Библиотека `pynput` работает без повышенных прав, но зависит от X11.
- Python-зависимости перечислены в `requirements.txt` (`pyperclip`, `keyboard`, `pynput`, `Pillow`).

## Установка

### Быстрый старт
```bash
cd /path/to/win_v
chmod +x install.sh
./install.sh
# После добавления в группу input требуется перелогиниться.
```

### Ручная установка
1. Установить системные зависимости:
   ```bash
   sudo apt-get update
   sudo apt-get install xclip xsel python3-tk
   ```
2. Создать и активировать виртуальное окружение:
   ```bash
   python3 -m venv venv
   source venv/bin/activate
   ```
3. Установить Python-зависимости:
   ```bash
   pip install --upgrade pip
   pip install -r requirements.txt
   ```
4. Разрешить перехват горячих клавиш (один раз):
   ```bash
   sudo usermod -a -G input $USER
   # Перелогиниться / перезагрузиться.
   ```
   Для тестов можно запускать `sudo venv/bin/python3 clipboard_history.py`, но для постоянной работы лучше настроить группу `input`.

## Запуск и управление
```bash
cd /path/to/win_v
source venv/bin/activate
python3 clipboard_history.py
```

Фоновый процесс можно остановить так:
```bash
./stop_app.sh
```

Логи выводятся в консоль; при запуске в фоне перенаправьте stdout/stderr или используйте `tmux`/`systemd`.

## Горячие клавиши
- `Ctrl+Alt+Z` — открыть окно истории (или поднять уже открытое).
- `Enter` / двойной щелчок — вставить выделенный элемент.
- `Esc` — закрыть окно.
- `↑`/`↓` — навигация по списку, включая поле поиска.
- В поле поиска ввод фильтрует список по содержимому текста/превью; изображения можно найти словом «изображение».

## Автозапуск
```bash
chmod +x setup_autostart.sh
./setup_autostart.sh
```
Создается `~/.config/autostart/clipboard-history.desktop`, который запускает приложение из виртуального окружения. Удалите файл, чтобы отключить автозапуск:
```bash
rm ~/.config/autostart/clipboard-history.desktop
```

## Хранение данных
- История: `~/.clipboard_history.json` (timestamp, type, текст/пути к изображениям, превью).
- Изображения и превью: `~/.clipboard_history_images/*.png`, именуются по MD5-хешу содержимого для дедупликации.
- При очистке истории файлы изображений удаляются.

## Структура репозитория
```
clipboard_history.py   # Основная логика приложения
requirements.txt       # Python-зависимости
install.sh             # Установка системных и Python-зависимостей
setup_autostart.sh     # Создание desktop-файла автозапуска
stop_app.sh            # Быстрая остановка процесса
INSTALL_RU.md          # Короткая инструкция по установке (RU)
README.md              # Этот файл
```

## FAQ и устранение проблем
- **Горячая клавиша не срабатывает**
  - Проверьте, что пользователь в группе `input` и вы перелогинились.
  - Убедитесь, что комбинация `Ctrl+Alt+Z` не занята другим приложением.
  - Установите `pynput`: `pip install pynput` (она используется как fallback).
  - Для Wayland может понадобиться запуск под XWayland или использование альтернативных средств глобальных хоткеев.
- **Буфер обмена не ловится**
  - Установите `xclip`/`xsel` и убедитесь, что работает X11.
  - Проверьте, не запускается ли приложение без доступа к дисплею (`$DISPLAY`).
- **Ошибки Pillow или нет превью**
  - Убедитесь, что `Pillow` установлена (см. `requirements.txt`). Без нее изображения сохраняются, но превью могут не создаваться.
- **Нужно изменить лимит истории или поведение очистки**
  - В `main()` замените `ClipboardHistory(max_history=100, clear_on_startup=True)` на свои значения.

## Лицензия и автор
Приложение создано для личного использования как аналог Win+V на Ubuntu/Linux. Используйте и модифицируйте под свои задачи.

